<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title>Social Guard</ion-title>
    <ion-buttons slot="end" (click)="multiple = !multiple">
      <ion-button>
        <i class="material-icons darkgrey" slot="icon-only">
          {{multiple ? 'dashboard' : 'view_agenda'}}
        </i>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-grid>
    <ion-text class="recent-title font-title3">Accueil</ion-text>
    <div class="section-list">
      <ion-grid class="section-grid">
        <ion-row>
          <ion-col
            *ngFor="let section of courseSections; trackBy: trackCourses"
            size-lg="6"
            size="12"
          >
            <ion-row class="section-container" [style.background]="section.color" (click)="openModal(section)">
              <ion-col>
                <ion-text class="font-title2">{{section.title}}</ion-text>
                <br />
                <div class="spacing"></div>
                <ion-text class="font-body">{{section.caption}}</ion-text>
              </ion-col>
              <ion-col size="auto" class="ion-align-items-center">
                <ion-img class="section-img" [src]="section.image"></ion-img>
              </ion-col>
            </ion-row>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
  </ion-grid>

  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ selectedSection?.title }}</ion-title>
          <ion-buttons slot="end">
            <ion-button class="modal-close-button" (click)="closeModal()">X</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <!-- Afficher le score si c'est la section "Votre Score" -->
        <ng-container *ngIf="selectedSection?.title === 'Votre Score'">
          <ngx-gauge
            [foregroundColor]="getGaugeColor()"
            type="semi"
            [value]="selectedScore"
            [min]="0"
            [max]="100"
            [cap]="'round'"
            [thick]="15"
            [backgroundColor]="'#e0e0e0'"
            [label]="'Score'"
            [append]="'%'">
          </ngx-gauge>
          <p [ngStyle]="getGaugeMessageStyle()" class="gauge-message-points">
            Votre score en points : {{ convertScoreToPoints(selectedScore) }}
          </p>
          <p [ngStyle]="getGaugeMessageStyle()" class="gauge-message">
            {{ getGaugeMessage() }}
          </p>
        </ng-container>

        <!-- Afficher le score si c'est la section "Événements" -->
        <ng-container *ngIf="selectedSection?.title === 'Événements'">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Événements</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <full-calendar [options]="calendarOptions">
                <ng-template #eventContent let-arg>
                  <b>{{arg.timeText}}</b>
                  <i>{{arg.event.title}}</i>
                </ng-template>
              </full-calendar>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <!-- Afficher le score si c'est la section "Cashback" -->
        <ng-container *ngIf="selectedSection?.title === 'Cashback'">
          <ion-card>
            <ion-card-header>
              <ion-card-title></ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let cashback of cashbackData" (click)="openUrl(cashback.title)">
                  <ion-label>
                    <h2>{{ cashback.title }}</h2>
                    <p>Date: {{ cashback.date }}</p>
                  </ion-label>
                  <ion-badge slot="end" color="success">{{ cashback.amount | currency:'%' }}</ion-badge>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ng-container>

        <!-- Afficher le parrainage si c'est la section "Parrainage" -->
        <ng-container *ngIf="selectedSection?.title === 'Parrainage'">
          <ion-list>
            <ion-item *ngFor="let parrainage of parrainageData" lines="none">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>{{ parrainage.title }}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <p>Date: {{ parrainage.date }}</p>
                  <ion-badge slot="end" color="success">{{ parrainage.title | currency:'EUR' }}</ion-badge>
                  <div class="parrainage-actions">
                    <ion-button color="primary" fill="outline" (click)="openParrainage(parrainage.url)">
                      Voir Détails
                    </ion-button>
                    <ion-button color="secondary" fill="solid">
                      Copier le lien
                    </ion-button>
                  </div>
                </ion-card-content>
              </ion-card>
            </ion-item>
          </ion-list>
        </ng-container>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Bouton flottant pour le chatbot -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="toggleChat()">
      <ion-icon name="chatbubbles"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Fenêtre de chat -->
  <div *ngIf="showChat" class="chat-window">
    <div class="chat-header">
      <h4>Chatbot</h4>
      <button class="close-btn" (click)="toggleChat()">X</button>
    </div>

    <div class="chat-body">
      <!-- Boucle pour afficher les messages -->
      <div *ngFor="let message of messages" class="chat-bubble" [ngClass]="message.type === 'user' ? 'user-message' : 'bot-message'">
        <p>{{ message.text }}</p>
      </div>
    </div>

    <div class="chat-footer">
      <ion-item lines="none">
        <ion-input class="chat-input" [(ngModel)]="userInput" placeholder="Tapez votre message..."></ion-input>
        <ion-button color="primary" slot="end" (click)="sendMessage()">
          <ion-icon name="send"></ion-icon>
        </ion-button>
      </ion-item>
    </div>
  </div>

</ion-content>
